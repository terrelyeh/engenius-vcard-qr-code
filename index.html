<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vCard QR Code ç”¢ç”Ÿå™¨</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #F4F4F5;
      --surface: #FFFFFF;
      --surface2: #FAFAFA;
      --border: #E4E4E7;
      --border-hover: #A1A1AA;
      --accent: #2563EB;
      --accent-hover: #1D4ED8;
      --accent-light: #EFF6FF;
      --accent-border: #BFDBFE;
      --text: #18181B;
      --muted: #71717A;
      --success: #16A34A;
      --success-bg: #F0FDF4;
      --success-border: #BBF7D0;
      --focus: #2563EB;
      --radius: 10px;
    }

    body {
      font-family: 'Inter', sans-serif;
      color: var(--text);
      min-height: 100vh;
      padding: 32px 16px 60px;
      background-color: #EEF0F3;
      background-image:
        linear-gradient(rgba(37,99,235,.055) 1px, transparent 1px),
        linear-gradient(90deg, rgba(37,99,235,.055) 1px, transparent 1px);
      background-size: 28px 28px;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 70% 50% at 75% -5%, rgba(37,99,235,.10) 0%, transparent 65%),
        radial-gradient(ellipse 50% 40% at 10% 100%, rgba(99,102,241,.07) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    .container, header { position: relative; z-index: 1; }

    /* Header */
    header { text-align: center; margin-bottom: 32px; }
    header h1 { font-size: clamp(1.4rem, 3.5vw, 1.9rem); font-weight: 700; color: var(--text); letter-spacing: -.02em; }
    header p { color: var(--muted); font-size: .875rem; margin-top: 6px; }

    /* Layout */
    .container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr 320px; gap: 20px; align-items: start; }
    @media (max-width: 760px) { .container { grid-template-columns: 1fr; } }

    /* Panel */
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .panel-title { font-size: .7rem; font-weight: 600; letter-spacing: .08em; text-transform: uppercase; color: var(--accent); margin-bottom: 16px; display: flex; align-items: center; gap: 7px; }

    /* Profile Selector */
    .profile-bar { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
    .profile-btn-wrap { flex: 1; min-width: 80px; display: flex; border-radius: 7px; border: 1px solid var(--border); overflow: hidden; background: var(--surface2); transition: border-color .15s; }
    .profile-btn-wrap:hover { border-color: var(--border-hover); }
    .profile-btn-wrap.active { border-color: var(--accent); background: var(--accent); }
    .profile-btn {
      flex: 1; padding: 8px 6px 8px 10px; border: none; background: transparent;
      color: var(--muted); font-family: 'Inter', sans-serif;
      font-size: .78rem; font-weight: 600; cursor: pointer; text-align: center;
      transition: color .15s;
    }
    .profile-btn-wrap:hover .profile-btn { color: var(--text); }
    .profile-btn-wrap.active .profile-btn { color: #fff; }
    .profile-edit-btn {
      padding: 0 8px; border: none; border-left: 1px solid rgba(0,0,0,.07);
      background: transparent; cursor: pointer; color: var(--muted);
      font-size: .72rem; transition: color .15s, background .15s;
      display: flex; align-items: center;
    }
    .profile-edit-btn:hover { color: var(--accent); background: rgba(37,99,235,.06); }
    .profile-btn-wrap.active .profile-edit-btn { border-left-color: rgba(255,255,255,.25); color: rgba(255,255,255,.8); }
    .profile-btn-wrap.active .profile-edit-btn:hover { color: #fff; background: rgba(255,255,255,.15); }
    .profile-btn-wrap.editing { border-color: var(--accent); }

    /* Profile Editor */
    #profile-editor {
      display: none; margin-bottom: 16px;
      background: #F0F6FF; border: 1px solid var(--accent-border);
      border-radius: 9px; padding: 14px 16px;
    }
    .editor-title {
      font-size: .7rem; font-weight: 600; letter-spacing: .06em;
      text-transform: uppercase; color: var(--accent); margin-bottom: 12px;
    }
    .editor-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    @media (max-width: 480px) { .editor-fields { grid-template-columns: 1fr; } }
    .editor-fields .field { margin-top: 0 !important; }
    .editor-btn-row { display: flex; gap: 7px; margin-top: 12px; }
    .btn-save { background: var(--accent); color: #fff; font-size: .8rem; padding: 7px 16px; }
    .btn-save:hover { background: var(--accent-hover); }
    .btn-cancel { font-size: .8rem; padding: 7px 14px; }

    /* Section label */
    .section-label { font-size: .68rem; font-weight: 600; letter-spacing: .07em; text-transform: uppercase; color: var(--muted); margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
    .section-label::before { content: ''; display: inline-block; width: 3px; height: 11px; background: var(--accent); border-radius: 2px; flex-shrink: 0; }

    /* Form */
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 480px) { .row { grid-template-columns: 1fr; } }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field + .field { margin-top: 10px; }
    .row .field + .field { margin-top: 0; }
    label { font-size: .73rem; font-weight: 500; color: var(--muted); }
    input {
      background: #fff; border: 1px solid var(--border); border-radius: 7px;
      color: var(--text); font-family: 'Inter', sans-serif; font-size: .875rem;
      padding: 9px 11px; transition: border-color .15s, box-shadow .15s;
      width: 100%; outline: none;
    }
    input:hover { border-color: var(--border-hover); }
    input:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(37,99,235,.12); }
    input::placeholder { color: #C4C4CA; }
    input.autofilled { border-color: var(--success); background: var(--success-bg); }

    /* Buttons */
    .btn-row { display: flex; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
    .btn { display: inline-flex; align-items: center; gap: 6px; border: none; border-radius: 7px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: .85rem; font-weight: 600; padding: 10px 18px; transition: background .15s, color .15s, border-color .15s; }
    .btn:active { opacity: .85; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-outline { background: #fff; border: 1px solid var(--border); color: var(--muted); }
    .btn-outline:hover { border-color: var(--border-hover); color: var(--text); }

    /* QR Panel */
    .qr-panel { position: sticky; top: 22px; }
    #qr-placeholder { background: var(--surface2); border: 1.5px dashed var(--border); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; gap: 10px; color: var(--muted); font-size: .82rem; text-align: center; padding: 20px; }
    #qr-output { display: none; flex-direction: column; align-items: center; gap: 14px; }
    #qr-output.visible { display: flex; }
    #qr-canvas-wrap { background: #fff; border-radius: 10px; padding: 14px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,.07); display: inline-block; }
    #qr-canvas-wrap canvas { display: block; }
    #qr-name { font-size: .95rem; font-weight: 700; text-align: center; color: var(--text); }
    #qr-company { font-size: .77rem; color: var(--muted); text-align: center; margin-top: -8px; }
    .dl-row { display: flex; gap: 7px; width: 100%; justify-content: center; }
    .btn-dl { flex: 1; justify-content: center; max-width: 130px; font-size: .78rem; padding: 8px 10px; }
    .badge { display: inline-flex; align-items: center; gap: 5px; background: var(--success-bg); color: var(--success); border: 1px solid var(--success-border); border-radius: 20px; font-size: .68rem; font-weight: 600; padding: 3px 10px; }
    .badge-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.3; } }

    /* vCard preview */
    #vcard-preview { display: none; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-size: .68rem; font-family: 'Courier New', monospace; color: #52525B; line-height: 1.7; white-space: pre; overflow-x: auto; max-height: 160px; overflow-y: auto; margin-top: 10px; }
    #vcard-preview.visible { display: block; }
    .toggle-preview { background: none; border: none; color: var(--muted); font-size: .72rem; cursor: pointer; padding: 0; margin-top: 8px; text-decoration: underline; font-family: 'Inter', sans-serif; }
    .toggle-preview:hover { color: var(--text); }

    /* OCR Zone */
    .ocr-zone {
      border: 1.5px dashed var(--border); border-radius: 9px; padding: 14px 16px;
      display: flex; align-items: center; gap: 12px; cursor: pointer;
      transition: border-color .15s, background .15s; margin-bottom: 8px;
      background: var(--surface2);
    }
    .ocr-zone:hover, .ocr-zone.drag-over { border-color: var(--accent); background: var(--accent-light); }
    .ocr-zone.loading { opacity: .65; pointer-events: none; }
    #ocr-status {
      font-size: .78rem; padding: 7px 11px; border-radius: 7px;
      margin-bottom: 8px; display: none;
    }
    #ocr-status.processing { background: #EFF6FF; color: var(--accent); border: 1px solid var(--accent-border); }
    #ocr-status.success    { background: var(--success-bg); color: var(--success); border: 1px solid var(--success-border); }
    #ocr-status.error      { background: #FFF1F2; color: #BE123C; border: 1px solid #FECDD3; }
    .ocr-lang {
      font-size: .72rem; border: 1px solid var(--border); border-radius: 5px;
      padding: 4px 6px; background: #fff; color: var(--muted); cursor: pointer;
      margin-left: auto; flex-shrink: 0; outline: none;
    }
    .ocr-lang:hover { border-color: var(--border-hover); }
    #ocr-preview {
      display: none; margin-bottom: 8px; border: 1px solid var(--border);
      border-radius: 8px; overflow: hidden; max-height: 320px; overflow-y: auto;
      background: var(--surface2);
    }
    #ocr-preview img { width: 100%; display: block; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

<header>
  <h1>vCard QR Code ç”¢ç”Ÿå™¨</h1>
  <p>é¸æ“‡å…¬å¸ Profileï¼Œå¡«å…¥è¯çµ¡è³‡è¨Šï¼Œå³æ™‚ç”¢ç”Ÿ vCard QR Code</p>
</header>

<div class="container">

  <!-- LEFT: Form -->
  <div class="panel">
    <div class="panel-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
      å…¬å¸ Profile
    </div>

    <!-- Profile Buttons -->
    <div class="profile-bar">
      <div class="profile-btn-wrap" data-profile="US">
        <button class="profile-btn" onclick="applyProfile('US')">ğŸ‡ºğŸ‡¸ US</button>
        <button class="profile-edit-btn" onclick="toggleEdit('US')" title="ç·¨è¼¯é è¨­å€¼">âœ</button>
      </div>
      <div class="profile-btn-wrap" data-profile="APAC">
        <button class="profile-btn" onclick="applyProfile('APAC')">ğŸŒ APAC</button>
        <button class="profile-edit-btn" onclick="toggleEdit('APAC')" title="ç·¨è¼¯é è¨­å€¼">âœ</button>
      </div>
      <div class="profile-btn-wrap" data-profile="Europe">
        <button class="profile-btn" onclick="applyProfile('Europe')">ğŸ‡ªğŸ‡º Europe</button>
        <button class="profile-edit-btn" onclick="toggleEdit('Europe')" title="ç·¨è¼¯é è¨­å€¼">âœ</button>
      </div>
      <div class="profile-btn-wrap" data-profile="Japan">
        <button class="profile-btn" onclick="applyProfile('Japan')">ğŸ‡¯ğŸ‡µ Japan</button>
        <button class="profile-edit-btn" onclick="toggleEdit('Japan')" title="ç·¨è¼¯é è¨­å€¼">âœ</button>
      </div>
    </div>

    <!-- Profile Editor -->
    <div id="profile-editor">
      <div class="editor-title">ç·¨è¼¯ <span id="editor-profile-name"></span> Profile é è¨­å€¼</div>
      <div class="editor-fields">
        <div class="field"><label for="edit-org">å…¬å¸åç¨±</label><input id="edit-org" type="text" /></div>
        <div class="field"><label for="edit-phoneWork">å…¬å¸é›»è©±</label><input id="edit-phoneWork" type="tel" /></div>
        <div class="field"><label for="edit-website">ç¶²ç«™</label><input id="edit-website" type="url" /></div>
        <div class="field" style="grid-column:1/-1"><label for="edit-address">åœ°å€</label><input id="edit-address" type="text" /></div>
      </div>
      <div class="editor-btn-row">
        <button class="btn btn-save" onclick="saveProfile()">å„²å­˜</button>
        <button class="btn btn-outline btn-cancel" onclick="closeEditor()">å–æ¶ˆ</button>
      </div>
    </div>

    <!-- Form Fields -->
    <!-- OCR Section -->
    <div class="section-label">åç‰‡ OCR è‡ªå‹•å¡«å…¥</div>
    <div id="ocr-zone" class="ocr-zone"
         onclick="document.getElementById('ocr-file').click()"
         ondragover="ocrDragOver(event)" ondragleave="ocrDragLeave()" ondrop="ocrDrop(event)">
      <input type="file" id="ocr-file" accept="image/*,.pdf" style="display:none"
             onchange="ocrHandleFile(this.files[0])">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="flex-shrink:0;color:var(--muted)"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <div style="flex:1">
        <div style="font-size:.82rem;font-weight:500;color:var(--text)">æ‹–æ›³æˆ–é»æ“Šä¸Šå‚³åç‰‡</div>
        <div style="font-size:.72rem;color:var(--muted);margin-top:2px">JPG / PNG / PDF Â· è‡ªå‹•è¾¨è­˜ä¸¦å¡«å…¥æ¬„ä½</div>
      </div>
      <span style="font-size:.72rem;color:var(--accent);font-weight:600;margin-left:auto;flex-shrink:0">âœ¦ AI</span>
    </div>
    <div id="ocr-status"></div>
    <div id="ocr-preview"><img id="ocr-preview-img" src="" alt="é è¦½" /></div>

    <div class="section-label">åŸºæœ¬è³‡è¨Š</div>
    <div class="field"><label for="fullName">å§“å</label><input id="fullName" type="text" placeholder="è‘‰ Terrel" oninput="liveUpdate()" /></div>
    <div class="row" style="margin-top:10px">
      <div class="field"><label for="org">å…¬å¸ / çµ„ç¹”</label><input id="org" type="text" placeholder="EnGenius Technologies Inc." oninput="liveUpdate()" /></div>
      <div class="field"><label for="title">è·ç¨±</label><input id="title" type="text" placeholder="Product Manager" oninput="liveUpdate()" /></div>
    </div>

    <div class="section-label">è¯çµ¡æ–¹å¼</div>
    <div class="row">
      <div class="field"><label for="phoneMobile">æ‰‹æ©Ÿ</label><input id="phoneMobile" type="tel" placeholder="+886 912 345 678" oninput="liveUpdate()" /></div>
      <div class="field"><label for="phoneWork">å…¬å¸é›»è©±</label><input id="phoneWork" type="tel" placeholder="+1 714 432 8668" oninput="liveUpdate()" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="field"><label for="emailWork">Email</label><input id="emailWork" type="email" placeholder="you@engeniustech.com" oninput="liveUpdate()" /></div>
      <div class="field"><label for="website">ç¶²ç«™</label><input id="website" type="url" placeholder="https://www.engeniustech.com" oninput="liveUpdate()" /></div>
    </div>

    <div class="section-label">åœ°å€</div>
    <div class="field"><label for="address">åœ°å€</label><input id="address" type="text" placeholder="1580 Scenic Ave. Costa Mesa, CA 92626" oninput="liveUpdate()" /></div>

    <!-- Buttons -->
    <div class="btn-row">
      <button class="btn btn-primary" onclick="generateQR()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><path d="M14 14h.01M14 18h.01M18 14h.01M18 18h.01"/></svg>
        ç”¢ç”Ÿ QR Code
      </button>
      <button class="btn btn-outline" onclick="clearAll()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.81"/></svg>
        æ¸…é™¤
      </button>
    </div>
  </div>

  <!-- RIGHT: QR Output -->
  <div class="panel qr-panel">
    <div class="panel-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><path d="M14 14h.01M14 18h.01M18 14h.01M18 18h.01"/></svg>
      QR Code é è¦½
    </div>

    <div id="qr-placeholder">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#D4D4D8" stroke-width="1.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><path d="M14 14h.01M14 18h.01M18 14h.01M18 18h.01"/></svg>
      <span>é¸æ“‡ Profile ä¸¦å¡«å…¥è³‡è¨Šå¾Œ<br>é»æ“Šã€Œç”¢ç”Ÿ QR Codeã€</span>
    </div>

    <div id="qr-output">
      <div id="qr-name"></div>
      <div id="qr-company"></div>
      <div id="qr-canvas-wrap"><div id="qr-canvas"></div></div>
      <div class="badge"><span class="badge-dot"></span>vCard 3.0</div>
      <div class="dl-row">
        <button class="btn btn-primary btn-dl" onclick="downloadQR()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          ä¸‹è¼‰ PNG
        </button>
        <button class="btn btn-outline btn-dl" onclick="downloadVCard()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          ä¸‹è¼‰ .vcf
        </button>
      </div>
      <button class="toggle-preview" onclick="togglePreview()">â–¾ æŸ¥çœ‹ vCard åŸå§‹ç¢¼</button>
      <pre id="vcard-preview"></pre>
    </div>
  </div>

</div>

<script>
  let currentVCard = '';
  let activeProfile = null;
  let activeEditKey = null;

  // â”€â”€ Load saved profiles from localStorage â”€â”€
  function loadProfiles() {
    try {
      const saved = localStorage.getItem('engenius_profiles');
      if (saved) Object.assign(PROFILES, JSON.parse(saved));
    } catch (e) {}
  }

  // â”€â”€ Profile Data â”€â”€
  const PROFILES = {
    US: {
      org: 'EnGenius Technologies Inc.',
      phoneWork: '',
      website: 'https://www.engeniustech.com',
      address: '1580 Scenic Ave. Costa Mesa, CA 92626'
    },
    APAC: {
      org: 'EnGenius Networks Singapore Pte Ltd',
      phoneWork: '+65 6227-1088',
      website: 'https://www.engeniustech.com',
      address: '215 Henderson Road #01-04 Henderson Industrial Park Singapore 159554'
    },
    Europe: {
      org: 'EnGenius Networks Europe B.V.',
      phoneWork: '+31 40 8200 888',
      website: 'https://www.engeniustech.com',
      address: 'Fellenoord 180, 5611 ZB Eindhoven, NL'
    },
    Japan: {
      org: 'EnGenius Networks Japan æ ªå¼ä¼šç¤¾',
      phoneWork: '03-6809-6608',
      website: 'https://www.engeniustech.com',
      address: '108-0023 æ±äº¬éƒ½æ¸¯åŒºèŠæµ¦ä¸‰ä¸ç›®6ç•ª14å· Expert Tamachi10éš'
    },
  };

  // â”€â”€ Profile Editor â”€â”€
  function toggleEdit(key) {
    const editor = document.getElementById('profile-editor');
    // Toggle off if same key
    if (activeEditKey === key && editor.style.display !== 'none') {
      closeEditor(); return;
    }
    activeEditKey = key;
    // Update editing highlight
    document.querySelectorAll('.profile-btn-wrap').forEach(w => w.classList.remove('editing'));
    document.querySelector(`.profile-btn-wrap[data-profile="${key}"]`).classList.add('editing');
    // Populate fields
    const p = PROFILES[key];
    document.getElementById('editor-profile-name').textContent = key;
    document.getElementById('edit-org').value = p.org || '';
    document.getElementById('edit-phoneWork').value = p.phoneWork || '';
    document.getElementById('edit-website').value = p.website || '';
    document.getElementById('edit-address').value = p.address || '';
    editor.style.display = 'block';
    editor.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function saveProfile() {
    if (!activeEditKey) return;
    PROFILES[activeEditKey] = {
      org:       document.getElementById('edit-org').value.trim(),
      phoneWork: document.getElementById('edit-phoneWork').value.trim(),
      website:   document.getElementById('edit-website').value.trim(),
      address:   document.getElementById('edit-address').value.trim(),
    };
    try { localStorage.setItem('engenius_profiles', JSON.stringify(PROFILES)); } catch (e) {}
    // Re-apply if this profile is currently active
    if (activeProfile === activeEditKey) applyProfile(activeEditKey);
    closeEditor();
  }

  function closeEditor() {
    document.getElementById('profile-editor').style.display = 'none';
    document.querySelectorAll('.profile-btn-wrap').forEach(w => w.classList.remove('editing'));
    activeEditKey = null;
  }

  function applyProfile(key) {
    activeProfile = key;
    document.querySelectorAll('.profile-btn-wrap').forEach(b => b.classList.remove('active'));
    document.querySelector(`.profile-btn-wrap[data-profile="${key}"]`).classList.add('active');

    const p = PROFILES[key];
    const setField = (id, val) => {
      const el = document.getElementById(id);
      el.value = val || '';
      if (val) el.classList.add('autofilled');
      else el.classList.remove('autofilled');
    };

    setField('org', p.org);
    setField('phoneWork', p.phoneWork);
    setField('website', p.website);
    setField('address', p.address);

    liveUpdate();
  }

  // â”€â”€ Build vCard â”€â”€
  function buildVCard() {
    const g = id => document.getElementById(id).value.trim();
    const fullName  = g('fullName');
    const org       = g('org');
    const title_    = g('title');
    const phoneMob  = g('phoneMobile');
    const phoneWork = g('phoneWork');
    const emailWork = g('emailWork');
    const address   = g('address');
    const website   = g('website');

    if (!fullName && !org) return null;

    const lines = ['BEGIN:VCARD', 'VERSION:3.0'];
    lines.push(`FN:${fullName || org}`);
    lines.push(`N:${fullName};;;;`);
    if (org)       lines.push(`ORG:${org}`);
    if (title_)    lines.push(`TITLE:${title_}`);
    if (phoneMob)  lines.push(`TEL;TYPE=CELL:${phoneMob}`);
    if (phoneWork) lines.push(`TEL;TYPE=WORK,VOICE:${phoneWork}`);
    if (emailWork) lines.push(`EMAIL;TYPE=WORK:${emailWork}`);
    if (address)   lines.push(`ADR;TYPE=WORK:;;${address};;;;`);
    if (website)   lines.push(`URL:${website}`);
    lines.push('END:VCARD');
    return lines.join('\n');
  }

  // â”€â”€ Generate QR â”€â”€
  function generateQR() {
    const vcard = buildVCard();
    if (!vcard) { alert('è«‹è‡³å°‘å¡«å…¥å§“åæˆ–å…¬å¸åç¨±'); return; }
    currentVCard = vcard;

    const g = id => document.getElementById(id).value.trim();
    const fullName = g('fullName'), org = g('org'), title_ = g('title');
    document.getElementById('qr-name').textContent = fullName || org;
    document.getElementById('qr-company').textContent =
      (fullName && org) ? `${title_ ? title_ + ' Â· ' : ''}${org}` : '';

    const wrap = document.getElementById('qr-canvas');
    wrap.innerHTML = '';
    const size = vcard.length > 600 ? 200 : 220;
    new QRCode(wrap, { text: vcard, width: size, height: size, colorDark: '#000', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.M });
    document.getElementById('vcard-preview').textContent = vcard;

    document.getElementById('qr-placeholder').style.display = 'none';
    document.getElementById('qr-output').classList.add('visible');
  }

  // â”€â”€ Live Update â”€â”€
  let debTimer;
  function liveUpdate() {
    clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      if (document.getElementById('qr-output').classList.contains('visible')) generateQR();
    }, 600);
  }

  // â”€â”€ Download PNG â”€â”€
  function downloadQR() {
    const img    = document.querySelector('#qr-canvas img');
    const canvas = document.querySelector('#qr-canvas canvas');

    const pad = 22;
    const out = document.createElement('canvas');
    const ctx = out.getContext('2d');

    const done = (dataUrl) => {
      const name = (document.getElementById('fullName').value || document.getElementById('org').value || 'contact')
        .trim().replace(/\s+/g, '_');
      const link = document.createElement('a');
      link.download = `vcard_${name}.png`;
      link.href = dataUrl;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    if (img && img.src && img.src.startsWith('data:')) {
      const i = new Image();
      i.onload = () => {
        out.width = i.width + pad * 2; out.height = i.height + pad * 2;
        ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, out.width, out.height);
        ctx.drawImage(i, pad, pad);
        done(out.toDataURL('image/png'));
      };
      i.src = img.src;
    } else if (canvas && canvas.width) {
      out.width = canvas.width + pad * 2; out.height = canvas.height + pad * 2;
      ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, out.width, out.height);
      ctx.drawImage(canvas, pad, pad);
      done(out.toDataURL('image/png'));
    }
  }

  // â”€â”€ Download .vcf â”€â”€
  function downloadVCard() {
    if (!currentVCard) return;
    const blob = new Blob([currentVCard], { type: 'text/vcard;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const name = (document.getElementById('fullName').value || document.getElementById('org').value || 'contact').trim().replace(/\s+/g, '_');
    link.download = `${name}.vcf`;
    link.href = url; link.click();
    URL.revokeObjectURL(url);
  }

  // â”€â”€ Toggle vCard Preview â”€â”€
  function togglePreview() {
    const el = document.getElementById('vcard-preview');
    const btn = document.querySelector('.toggle-preview');
    el.classList.toggle('visible');
    btn.textContent = el.classList.contains('visible') ? 'â–´ éš±è— vCard åŸå§‹ç¢¼' : 'â–¾ æŸ¥çœ‹ vCard åŸå§‹ç¢¼';
  }

  // â”€â”€ Clear All â”€â”€
  function clearAll() {
    document.querySelectorAll('input').forEach(el => { el.value = ''; el.classList.remove('autofilled'); });
    currentVCard = '';
    document.querySelectorAll('.profile-btn-wrap').forEach(b => b.classList.remove('active'));
    activeProfile = null;
    closeEditor();
    document.getElementById('qr-placeholder').style.display = 'flex';
    document.getElementById('qr-output').classList.remove('visible');
    document.getElementById('vcard-preview').classList.remove('visible');
    document.getElementById('ocr-preview').style.display = 'none';
    document.getElementById('ocr-preview-img').src = '';
    document.getElementById('ocr-status').style.display = 'none';
  }

  // â”€â”€ OCR via Gemini Vision (proxied through /api/ocr) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function ocrDragOver(e) { e.preventDefault(); document.getElementById('ocr-zone').classList.add('drag-over'); }
  function ocrDragLeave()  { document.getElementById('ocr-zone').classList.remove('drag-over'); }
  function ocrDrop(e) {
    e.preventDefault();
    document.getElementById('ocr-zone').classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) ocrHandleFile(file);
  }

  async function ocrHandleFile(file) {
    if (!file) return;
    const zone = document.getElementById('ocr-zone');
    zone.classList.add('loading');
    ocrSetStatus('processing', 'â³ è™•ç†åœ–åƒä¸­...');
    try {
      let dataUrl, mimeType;

      if (file.type === 'application/pdf') {
        ocrSetStatus('processing', 'â³ è½‰æ› PDF...');
        dataUrl  = await ocrPdfPage(file);
        mimeType = 'image/png';
      } else {
        dataUrl  = await ocrFileToDataUrl(file);
        mimeType = file.type || 'image/jpeg';
      }

      // Show preview
      document.getElementById('ocr-preview-img').src = dataUrl;
      document.getElementById('ocr-preview').style.display = 'block';

      ocrSetStatus('processing', 'â³ AI è¾¨è­˜ä¸­...');
      const base64 = dataUrl.split(',')[1];
      const fields = await ocrCallGemini(base64, mimeType);
      const filled = ocrFill(fields);
      ocrSetStatus('success', `âœ“ è¾¨è­˜å®Œæˆï¼Œå·²å¡«å…¥ ${filled} å€‹æ¬„ä½`);
    } catch (err) {
      console.error('OCR error:', err);
      ocrSetStatus('error', 'âœ— è¾¨è­˜å¤±æ•—ï¼š' + (err.message || 'è«‹ç¨å¾Œå†è©¦'));
    } finally {
      zone.classList.remove('loading');
      document.getElementById('ocr-file').value = '';
    }
  }

  function ocrSetStatus(type, msg) {
    const el = document.getElementById('ocr-status');
    el.className = type; el.textContent = msg; el.style.display = 'block';
  }

  function ocrFileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload  = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function ocrCallGemini(base64, mimeType) {
    const res = await fetch('/api/ocr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ base64, mimeType })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const match = text.match(/\{[\s\S]*\}/);
    if (!match) throw new Error('ç„¡æ³•è§£æ AI å›æ‡‰');
    return JSON.parse(match[0]);
  }

  async function ocrPdfPage(file) {
    if (typeof pdfjsLib === 'undefined') {
      await new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    }
    const ab  = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
    const scale = 2.5, gap = 20;

    // Render every page to its own canvas
    const pages = [];
    for (let i = 1; i <= pdf.numPages; i++) {
      ocrSetStatus('processing', `â³ è½‰æ› PDF ç¬¬ ${i}/${pdf.numPages} é ...`);
      const pg = await pdf.getPage(i);
      const vp = pg.getViewport({ scale });
      const cv = document.createElement('canvas');
      cv.width = vp.width; cv.height = vp.height;
      await pg.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
      pages.push(cv);
    }

    // Stitch all pages vertically into one canvas
    const maxW = Math.max(...pages.map(c => c.width));
    const totalH = pages.reduce((s, c) => s + c.height, 0) + gap * (pages.length - 1);
    const out = document.createElement('canvas');
    out.width = maxW; out.height = totalH;
    const ctx = out.getContext('2d');
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, maxW, totalH);
    let y = 0;
    pages.forEach(c => { ctx.drawImage(c, 0, y); y += c.height + gap; });
    return out.toDataURL('image/png');
  }

  function ocrFill(fields) {
    let count = 0;
    Object.entries(fields).forEach(([k, v]) => {
      if (!v) return;
      const el = document.getElementById(k);
      if (!el) return;
      el.value = v;
      el.classList.add('autofilled');
      count++;
    });
    if (count) liveUpdate();
    return count;
  }

  // Init
  loadProfiles();
</script>
</body>
</html>
